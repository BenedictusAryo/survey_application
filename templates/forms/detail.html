{% extends 'base.html' %}
{% load form_extras %}

{% block title %}{{ form.title }} - Form Details{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex-1">
            <div class="breadcrumbs text-sm mb-2">
                <ul>
                    <li><a href="{% url 'forms:list' %}"><i class="fas fa-home"></i> Forms</a></li>
                    <li class="text-primary">{{ form.title }}</li>
                </ul>
            </div>
            <h1 class="text-5xl lg:text-7xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent mb-2">
                {{ form.title }}
            </h1>
            <p class="text-base-content/70 text-lg">{{ form.description }}</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <a href="{% url 'forms:edit' form.pk %}" class="btn btn-outline gap-2">
                <i class="fas fa-edit"></i>
                <span class="hidden sm:inline">Edit Details</span>
            </a>
            <a href="{% url 'forms:questions' form.pk %}" class="btn btn-primary gap-2">
                <i class="fas fa-list"></i>
                <span class="hidden sm:inline">Manage Questions</span>
            </a>
            <a href="{% url 'forms:publish' form.pk %}" class="btn {% if form.status == 'published' %}btn-success{% else %}btn-warning{% endif %} gap-2">
                <i class="fas fa-{% if form.status == 'published' %}check-circle{% else %}upload{% endif %}"></i>
                <span class="hidden sm:inline">{% if form.status == 'published' %}Published{% else %}Publish{% endif %}</span>
            </a>
            {% if form.status == 'published' %}
                <a href="{% url 'forms:qr_code' form.slug %}" class="btn btn-secondary gap-2">
                    <i class="fas fa-qrcode"></i>
                    <span class="hidden sm:inline">QR Code</span>
                </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-8">
    <!-- Status Card -->
    <div class="stats shadow bg-base-100 border border-base-300">
        <div class="stat">
            <div class="stat-figure text-{% if form.status == 'published' %}success{% else %}warning{% endif %}">
                <i class="fas fa-{% if form.status == 'published' %}check-circle{% else %}clock{% endif %} text-3xl"></i>
            </div>
            <div class="stat-title">Status</div>
            <div class="stat-value text-{% if form.status == 'published' %}success{% else %}warning{% endif %} text-2xl">
                {{ form.get_status_display }}
            </div>
            {% if form.status == 'published' %}
                <div class="stat-actions mt-2">
                    <a href="/survey/{{ form.slug }}/" target="_blank" class="btn btn-xs btn-success gap-1">
                        <i class="fas fa-external-link-alt"></i>
                        View Public
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Responses Card -->
    <div class="stats shadow bg-base-100 border border-base-300">
        <div class="stat">
            <div class="stat-figure text-primary">
                <i class="fas fa-comments text-3xl"></i>
            </div>
            <div class="stat-title">Responses</div>
            <div class="stat-value text-primary">{{ response_count }}</div>
            <div class="stat-desc">Total submissions</div>
        </div>
    </div>
    
    <!-- Questions Card -->
    <div class="stats shadow bg-base-100 border border-base-300">
        <div class="stat">
            <div class="stat-figure text-secondary">
                <i class="fas fa-question-circle text-3xl"></i>
            </div>
            <div class="stat-title">Questions</div>
            <div class="stat-value text-secondary">{{ questions.count }}</div>
            <div class="stat-desc">Form fields</div>
        </div>
    </div>
    
    <!-- Last Updated Card -->
    <div class="stats shadow bg-base-100 border border-base-300">
        <div class="stat">
            <div class="stat-figure text-accent">
                <i class="fas fa-calendar-alt text-3xl"></i>
            </div>
            <div class="stat-title">Last Updated</div>
            <div class="stat-value text-accent text-lg">{{ form.updated_at|date:"M d" }}</div>
            <div class="stat-desc">{{ form.updated_at|time:"h:i A" }}</div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Sidebar: Master Data & Collaborators -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Master Data Attachments Card -->
        <div class="card bg-base-100 shadow-xl border border-base-300 hover:shadow-2xl transition-all duration-300">
            <div class="card-body">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-3 bg-primary/10 rounded-lg">
                        <i class="fas fa-database text-2xl text-primary"></i>
                    </div>
                    <h2 class="card-title text-xl">Master Data Sets</h2>
                </div>
                
                {% include 'forms/partials/master_data_attachments.html' with master_data_attachments=master_data_attachments %}
                
                <div class="divider my-2"></div>
                <button class="btn btn-primary gap-2 w-full" onclick="openAttachModal()">
                    <i class="fas fa-plus-circle"></i>
                    Attach Master Data
                </button>
            </div>
        </div>
        
        <!-- Collaborators Card -->
        <div class="card bg-base-100 shadow-xl border border-base-300 hover:shadow-2xl transition-all duration-300">
            <div class="card-body">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-3 bg-secondary/10 rounded-lg">
                        <i class="fas fa-users text-2xl text-secondary"></i>
                    </div>
                    <h2 class="card-title text-xl">Collaborators</h2>
                </div>
                
                <div class="space-y-2 mb-4">
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-primary/10 to-primary/5 rounded-lg border border-primary/20">
                        <div class="flex items-center gap-2">
                            <div class="avatar placeholder">
                                <div class="bg-primary text-primary-content rounded-full w-8">
                                    <span class="text-xs">{{ form.owner.username|first|upper }}</span>
                                </div>
                            </div>
                            <span class="font-medium">{{ form.owner.username }}</span>
                        </div>
                        <span class="badge badge-primary gap-1">
                            <i class="fas fa-crown text-xs"></i>
                            Owner
                        </span>
                    </div>
                    {% for editor in collaborators %}
                        <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg hover:bg-base-300 transition-colors">
                            <div class="flex items-center gap-2">
                                <div class="avatar placeholder">
                                    <div class="bg-secondary text-secondary-content rounded-full w-8">
                                        <span class="text-xs">{{ editor.username|first|upper }}</span>
                                    </div>
                                </div>
                                <span class="font-medium">{{ editor.username }}</span>
                            </div>
                            <span class="badge badge-secondary badge-sm">Editor</span>
                        </div>
                    {% endfor %}
                </div>
                
                <button class="btn btn-outline btn-secondary gap-2 w-full" onclick="inviteCollaborator()">
                    <i class="fas fa-user-plus"></i>
                    Invite Collaborator
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content: Questions & Actions -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Questions Card -->
        <div class="card bg-base-100 shadow-xl border border-base-300 hover:shadow-2xl transition-all duration-300">
            <div class="card-body">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="p-3 bg-accent/10 rounded-lg">
                            <i class="fas fa-list-ul text-2xl text-accent"></i>
                        </div>
                        <h2 class="card-title text-2xl">Questions</h2>
                    </div>
                    <a href="{% url 'forms:questions' form.pk %}" class="btn btn-primary gap-2">
                        <i class="fas fa-cog"></i>
                        Manage
                    </a>
                </div>
                
                {% if questions %}
                    <div class="space-y-3">
                        {% for question in questions %}
                            <div class="p-5 border-2 border-base-300 rounded-xl hover:border-primary/30 hover:bg-base-200/50 transition-all duration-300 group">
                                <div class="flex items-start gap-3">
                                    <div class="flex-shrink-0">
                                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center font-bold text-primary">
                                            {{ question.order }}
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex flex-wrap items-center gap-2 mb-3">
                                            <span class="badge badge-primary badge-sm">{{ question.get_question_type_display }}</span>
                                            {% if question.is_required %}
                                                <span class="badge badge-error badge-sm gap-1">
                                                    <i class="fas fa-asterisk text-xs"></i>
                                                    Required
                                                </span>
                                            {% endif %}
                                            {% if question.logic %}
                                                <span class="badge badge-info badge-sm gap-1">
                                                    <i class="fas fa-code-branch text-xs"></i>
                                                    Conditional
                                                </span>
                                            {% endif %}
                                        </div>
                                        <p class="font-semibold text-lg mb-2">{{ question.text|urlize_target_blank }}</p>
                                        {% if question.question_type == 'single_select' or question.question_type == 'multi_select' %}
                                            <div class="flex items-center gap-2 text-sm text-base-content/60">
                                                <i class="fas fa-list"></i>
                                                <span>{{ question.options|length }} option{{ question.options|length|pluralize }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-16">
                        <div class="inline-block p-4 bg-base-200 rounded-full mb-4">
                            <i class="fas fa-question-circle text-5xl text-base-content/30"></i>
                        </div>
                        <p class="text-base-content/60 mb-6 text-lg">No questions added yet.</p>
                        <a href="{% url 'forms:questions' form.pk %}" class="btn btn-primary btn-lg gap-2">
                            <i class="fas fa-plus-circle"></i>
                            Add Your First Question
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Form Actions Card -->
        <div class="card bg-base-100 shadow-xl border border-base-300 hover:shadow-2xl transition-all duration-300">
            <div class="card-body">
                <div class="flex items-center gap-3 mb-6">
                    <div class="p-3 bg-info/10 rounded-lg">
                        <i class="fas fa-bolt text-2xl text-info"></i>
                    </div>
                    <h2 class="card-title text-2xl">Quick Actions</h2>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    {% if form.status == 'draft' %}
                        <a href="{% url 'forms:publish' form.pk %}" class="btn btn-success gap-2 btn-lg">
                            <i class="fas fa-rocket"></i>
                            Publish Form
                        </a>
                    {% elif form.status == 'published' %}
                        <button class="btn btn-warning gap-2" onclick="unpublishForm()">
                            <i class="fas fa-eye-slash"></i>
                            <span class="hidden sm:inline">Unpublish</span>
                        </button>
                    {% endif %}
                    
                    <a href="{% url 'forms:responses' form.pk %}" class="btn btn-info gap-2">
                        <i class="fas fa-chart-bar"></i>
                        <span class="hidden sm:inline">View</span> Responses
                    </a>
                    
                    {% if form.status == 'published' %}
                        <button class="btn btn-secondary gap-2" onclick="copyPublicLink()">
                            <i class="fas fa-link"></i>
                            Copy Link
                        </button>
                        
                        <button class="btn btn-success gap-2" onclick="shareToWhatsApp()">
                            <i class="fab fa-whatsapp"></i>
                            Share
                        </button>
                    {% endif %}
                    
                    <button class="btn btn-outline gap-2" onclick="duplicateForm()">
                        <i class="fas fa-copy"></i>
                        Duplicate
                    </button>
                    
                    <button class="btn btn-error btn-outline gap-2" onclick="deleteForm()">
                        <i class="fas fa-trash-alt"></i>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function viewDataset(datasetId) {
    window.location.href = `/master-data/${datasetId}/`;
}

function openAttachModal() {
    const modal = document.getElementById('attach-master-data-modal');
    const content = document.getElementById('attach-modal-content');
    
    // Show loading spinner
    content.innerHTML = '<div class="loading loading-spinner loading-lg mx-auto"></div>';
    modal.classList.add('modal-open');
    
    // Load available datasets via fetch as fallback if HTMX is not available
    if (typeof htmx !== 'undefined') {
        htmx.ajax('GET', '{% url "forms:master_data_available" form.pk %}', {
            target: '#attach-modal-content'
        });
    } else {
        // Fallback to fetch API
        fetch('{% url "forms:master_data_available" form.pk %}')
            .then(response => response.text())
            .then(html => {
                content.innerHTML = html;
                // Attach click handlers for attach buttons
                attachModalHandlers();
            })
            .catch(error => {
                content.innerHTML = `<div class="alert alert-error"><span>Error loading datasets: ${error.message}</span></div>`;
            });
    }
}

function attachModalHandlers() {
    // Find all attach buttons and add click handlers
    const attachButtons = document.querySelectorAll('[data-attach-dataset]');
    attachButtons.forEach(button => {
        button.addEventListener('click', function() {
            const datasetId = this.getAttribute('data-attach-dataset');
            attachDataset(datasetId);
        });
    });
}

function attachDataset(datasetId) {
    const formData = new FormData();
    formData.append('dataset_id', datasetId);
    
    // Get CSRF token
    const csrfToken = getCookie('csrftoken');
    
    fetch('{% url "forms:master_data_attach" form.pk %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken || ''
        }
    })
    .then(response => response.text())
    .then(html => {
        // Update the master data attachments section
        const attachmentsContainer = document.getElementById('master-data-attachments');
        if (attachmentsContainer) {
            attachmentsContainer.outerHTML = html;
        }
        
        // Close modal
        closeAttachModal();
        
        // Show success message
        showToast('Master data attached successfully!', 'success');
        
        // Reload the page to refresh the data
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    })
    .catch(error => {
        showToast('Error attaching dataset: ' + error.message, 'error');
    });
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
    toast.innerHTML = `<div class="alert ${alertClass}"><span>${message}</span></div>`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (document.body.contains(toast)) {
            document.body.removeChild(toast);
        }
    }, 3000);
}

function closeAttachModal() {
    document.getElementById('attach-master-data-modal').classList.remove('modal-open');
}

function inviteCollaborator() {
    alert('Invite Collaborator functionality will be implemented with HTMX');
}

function unpublishForm() {
    if (confirm('Are you sure you want to unpublish this form?')) {
        alert('Unpublish functionality will be implemented');
    }
}

function copyPublicLink() {
    const link = `${window.location.origin}/survey/{{ form.slug }}/`;
    navigator.clipboard.writeText(link).then(() => {
        alert('Link copied to clipboard!');
    });
}

function shareToWhatsApp() {
    const link = `${window.location.origin}/survey/{{ form.slug }}/`;
    const text = encodeURIComponent(`Check out this survey: {{ form.title }}\n${link}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function duplicateForm() {
    if (confirm('Create a duplicate of this form?')) {
        alert('Duplicate functionality will be implemented');
    }
}

function deleteForm() {
    if (confirm('Are you sure you want to delete this form? This action cannot be undone.')) {
        alert('Delete functionality will be implemented');
    }
}

// HTMX event listeners for better UX (only if HTMX is available)
if (typeof htmx !== 'undefined') {
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.xhr.status === 200 && evt.detail.pathInfo.pathname.includes('master-data/attach')) {
            // Close modal after successful attachment
            closeAttachModal();
            
            // Show success message
            showToast('Master data attached successfully!', 'success');
            
            // Reload the page to refresh the data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }
        
        if (evt.detail.xhr.status === 200 && evt.detail.pathInfo.pathname.includes('master-data/configure')) {
            // Close modal after successful configuration
            closeConfigureModal();
            
            // Show success message
            showToast('Master data configuration updated!', 'success');
        }
    });
}

// Handle modal close on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAttachModal();
        closeConfigureModal();
    }
});

function configureAttachment(attachmentId) {
    const modal = document.getElementById('configure-attachment-modal');
    const content = document.getElementById('configure-modal-content');
    
    // Show loading spinner
    content.innerHTML = '<div class="loading loading-spinner loading-lg mx-auto"></div>';
    modal.classList.add('modal-open');
    
    // Load configuration form
    if (typeof htmx !== 'undefined') {
        htmx.ajax('GET', `/forms/{{ form.pk }}/master-data/configure/${attachmentId}/`, {
            target: '#configure-modal-content'
        });
    } else {
        // Fallback
        fetch(`/forms/{{ form.pk }}/master-data/configure/${attachmentId}/`)
            .then(response => response.text())
            .then(html => {
                content.innerHTML = html;
            })
            .catch(error => {
                content.innerHTML = `<div class="alert alert-error"><span>Error loading configuration: ${error.message}</span></div>`;
            });
    }
}

function closeConfigureModal() {
    document.getElementById('configure-attachment-modal').classList.remove('modal-open');
}
</script>

<!-- Master Data Attachment Modal -->
<div class="modal" id="attach-master-data-modal">
    <div class="modal-box w-11/12 max-w-4xl" id="attach-modal-content">
        <!-- Content will be loaded via HTMX -->
        <div class="loading loading-spinner loading-lg mx-auto"></div>
    </div>
    <div class="modal-backdrop" onclick="closeAttachModal()"></div>
</div>

<!-- Configure Attachment Modal -->
<div class="modal" id="configure-attachment-modal">
    <div class="modal-box" id="configure-modal-content">
        <!-- Content will be loaded via HTMX -->
        <div class="loading loading-spinner loading-lg mx-auto"></div>
    </div>
    <div class="modal-backdrop" onclick="closeConfigureModal()"></div>
</div>
{% endblock %}
